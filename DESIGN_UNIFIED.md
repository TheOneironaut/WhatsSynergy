# WhatsSynergy - ××¡××š ×¢×™×¦×•×‘ ×××•×—×“
## ×ª×™×¢×•×“ ××§×™×£ ×•×ª××¦×™×ª×™ ×©×œ ×”××¢×¨×›×ª

**×ª××¨×™×š:** 8 ××•×§×˜×•×‘×¨ 2025  
**×’×¨×¡×”:** 3.0  
**××˜×¨×”:** ××¡××š ××—×“ ×©××›×™×œ ×”×›×œ - ×ª×›× ×•×Ÿ, ××¨×›×™×˜×§×˜×•×¨×”, ×•×“×•×’×××•×ª

---

## ğŸ“‹ ×ª×•×›×Ÿ ×¢× ×™×™× ×™×

### ×—×œ×§ ×: ××‘×•×
1. [××”×™ WhatsSynergy?](#××”×™-whatssynergy)
2. [×¤×™×œ×•×¡×•×¤×™×™×ª ×¢×™×¦×•×‘](#×¤×™×œ×•×¡×•×¤×™×™×ª-×¢×™×¦×•×‘)
3. [××¤×ª ×“×¨×›×™× ××”×™×¨×”](#××¤×ª-×“×¨×›×™×-××”×™×¨×”)

### ×—×œ×§ ×‘: ××¨×›×™×˜×§×˜×•×¨×”
4. [×¡×§×™×¨×” ×›×œ×œ×™×ª](#×¡×§×™×¨×”-×›×œ×œ×™×ª)
5. [7 ×©×›×‘×•×ª ×”××¢×¨×›×ª](#×©×‘×¢-×©×›×‘×•×ª-×”××¢×¨×›×ª)
6. [×–×¨×™××ª × ×ª×•× ×™×](#×–×¨×™××ª-× ×ª×•× ×™×)

### ×—×œ×§ ×’: ×¨×›×™×‘×™× ××¨×›×–×™×™×
7. [Evolution API & Adapter](#evolution-api--adapter)
8. [Message Handler](#message-handler)
9. [Bot Interface](#bot-interface)
10. [××¢×¨×›×ª ×”×¤×™×œ×˜×¨×™×](#××¢×¨×›×ª-×”×¤×™×œ×˜×¨×™×)
11. [××¢×¨×›×ª ×”×¤×œ××’×™× ×™×](#××¢×¨×›×ª-×”×¤×œ××’×™× ×™×)
12. [Database Layer](#database-layer)

### ×—×œ×§ ×“: ××¢×©×™
13. [×”×ª×—×œ×” ××”×™×¨×”](#×”×ª×—×œ×”-××”×™×¨×”)
14. [×“×•×’×××•×ª × ×¤×•×¦×•×ª](#×“×•×’×××•×ª-× ×¤×•×¦×•×ª)
15. [×”×—×œ×˜×•×ª ×ª×›× ×•×Ÿ](#×”×—×œ×˜×•×ª-×ª×›× ×•×Ÿ)

### ×—×œ×§ ×”: ×”×ª×§×“××•×ª
16. [××‘×˜×—×”](#××‘×˜×—×”)
17. [×‘×™×¦×•×¢×™× ×•×§× ×” ××™×“×”](#×‘×™×¦×•×¢×™×-×•×§× ×”-××™×“×”)
18. [Best Practices](#best-practices)

---

## ğŸ¯ ××”×™ WhatsSynergy?

### ×”×’×“×¨×”
**WhatsSynergy** ×”×™× **××¤×œ×™×§×¦×™×™×ª ×‘×•×˜ WhatsApp** ×©×‘× ×•×™×” ×¢×œ **`whatsapi-python`** - ×¡×¤×¨×™×™×ª Python ×›×œ×œ×™×ª ×œ×¢×‘×•×“×” ×¢× WhatsApp.

### ×”××‘× ×” ×”×›×¤×•×œ

#### ğŸ“¦ `whatsapi-python` - ×”×¡×¤×¨×™×” (Framework)
**×¡×¤×¨×™×™×” ×›×œ×œ×™×ª** ×œ×¢×‘×•×“×” ×¢× WhatsApp ×“×¨×š Evolution API:
- ğŸ”Œ **Evolution API Adapter** - ×—×™×‘×•×¨ ×œ-WhatsApp
- ğŸ“¨ **Message Models** - ××•×‘×™×™×§×˜×™× ×œ× ×™×”×•×œ ×”×•×“×¢×•×ª
- ğŸ¯ **Webhook Handler** - ×§×‘×œ×ª ×”×•×“×¢×•×ª
- âš¡ **Async API** - ×‘×™×¦×•×¢×™× ×’×‘×•×”×™×

â†’ **× ×™×ª× ×ª ×œ×©×™××•×© ×—×•×–×¨** ×‘×›×œ ×¤×¨×•×™×§×˜ Python ×©×¦×¨×™×š WhatsApp

#### ğŸ¤– WhatsSynergy - ×”××¤×œ×™×§×¦×™×”
**××¤×œ×™×§×¦×™×” ×¡×¤×¦×™×¤×™×ª** ×©××©×ª××©×ª ×‘-`whatsapi-python`:
- ğŸ¯ **Bot Framework** - ××¢×¨×›×ª handlers ×•×¤×™×œ×˜×¨×™×
- ğŸ§© **Plugin System** - ×¤×œ××’×™× ×™× ×“×™× ××™×™×
- ğŸ—„ï¸ **Database** - × ×™×”×•×œ ××©×ª××©×™× ×•×©×™×—×•×ª
- ğŸ—ï¸ **Business Logic** - ×”×§×•×“ ×”×¢×¡×§×™ ×©×œ×š

â†’ **××¤×œ×™×§×¦×™×” ×¨×’×™×œ×”** ×¢× main.py ×•×¤×œ××’×™× ×™×

### ×œ××™ ×–×” ××ª××™×?

**××ª ×”×¡×¤×¨×™×” `whatsapi-python`:**
- âœ… ×›×œ ×¤×¨×•×™×§×˜ ×©×¦×¨×™×š ×œ×©×œ×•×—/×œ×§×‘×œ ×”×•×“×¢×•×ª WhatsApp
- âœ… ××™× ×˜×’×¨×¦×™×” ×©×œ WhatsApp ×‘××¢×¨×›×•×ª ×§×™×™××•×ª
- âœ… ×‘×•×˜×™× ×¤×©×•×˜×™× ×œ×œ× ×¦×•×¨×š ×‘×¤×œ××’×™× ×™×

**××ª ××¤×œ×™×§×¦×™×™×ª WhatsSynergy:**
- âœ… ×‘×•×˜×™× ×¢×¡×§×™×™× ×œ×©×™×¨×•×ª ×œ×§×•×—×•×ª
- âœ… ×‘×•×˜×™× ×¢× ×¤×œ××’×™× ×™× ××¨×•×‘×™×
- âœ… × ×™×”×•×œ ×§×”×™×œ×•×ª ×•×§×‘×•×¦×•×ª
- âœ… ×‘×•×˜×™× ××™× ×˜×¨××§×˜×™×‘×™×™× ×¢× state

---

## ğŸ’­ ×¤×™×œ×•×¡×•×¤×™×™×ª ×¢×™×¦×•×‘

### 4 ×¢×§×¨×•× ×•×ª ××¨×›×–×™×™×

#### 1. Separation of Concerns
**×›×œ ×¨×›×™×‘ ××—×¨××™ ×¢×œ ×ª×—×•× ××—×“ ×‘×œ×‘×“.**

×ª×§×©×•×¨×ª â‰  × ×™×ª×•×‘ â‰  ×œ×•×’×™×§×” â‰  ××—×¡×•×Ÿ

**×ª×•×¢×œ×ª:** ×©×™× ×•×™ ×‘××—×ª ×”×©×›×‘×•×ª ×œ× ××©×¤×™×¢ ×¢×œ ××—×¨×•×ª.

#### 2. Modularity & Loose Coupling
**×¨×›×™×‘×™× ××ª×§×©×¨×™× ×“×¨×š ×××©×§×™×, ×œ× ××™××•×©×™×.**

Bot ×œ× ×™×•×“×¢ ××™×–×” Adapter ××©××© â†’ ×§×œ ×œ×”×—×œ×™×£ ×¡×¤×§ WhatsApp

**×ª×•×¢×œ×ª:** ×”×—×œ×¤×ª ××™××•×©×™× ××¤×©×¨×™×ª ×‘×§×œ×•×ª.

#### 3. Easy Extensibility
**×”×•×¡×¤×ª ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×—×™×™×‘×ª ×œ×”×™×•×ª ×¤×©×•×˜×”.**

×¤×œ××’×™×Ÿ ×—×“×© = ×ª×™×§×™×™×” ×—×“×©×”. ×–×”×•.

**×ª×•×¢×œ×ª:** ×¢×§×•××ª ×œ××™×“×” × ××•×›×”, ×¤×™×ª×•×— ××”×™×¨.

#### 4. Reliability & Resilience
**×”××¢×¨×›×ª ×××©×™×›×” ×œ×¤×¢×•×œ ×’× ×›×©×¨×›×™×‘×™× × ×›×©×œ×™×.**

×©×’×™××” ×‘×¤×œ××’×™×Ÿ ××—×“ ×œ× ××¤×™×œ×” ××ª ×”×‘×•×˜

**×ª×•×¢×œ×ª:** ×–××Ÿ ×¤×¢×™×œ×•×ª ×’×‘×•×” (high availability).

---

## ğŸ—ºï¸ ××¤×ª ×“×¨×›×™× ××”×™×¨×”

### ×œ××ª×—×™×œ
```
5 ×“×§×•×ª:   ×”×‘×Ÿ ××ª ×”×”×‘×“×œ ×‘×™×Ÿ ×”×¡×¤×¨×™×” ×œ××¤×œ×™×§×¦×™×”
10 ×“×§×•×ª:  ×”×ª×§× ×” ×•×”×’×“×¨×” â†’ main.py â†’ ×”×¨×¥
20 ×“×§×•×ª:  ×¤×œ××’×™×Ÿ ×¨××©×•×Ÿ
30 ×“×§×•×ª:  ×”×‘×Ÿ ××ª ××¢×¨×›×ª ×”×¤×™×œ×˜×¨×™×
60 ×“×§×•×ª:  ×‘×•×˜ ××œ× ×¢× database
```

### ×œ××¤×ª×— ×× ×•×¡×”
```
5 ×“×§×•×ª:   ×”×‘×Ÿ ××ª ×”××‘× ×” ×”×›×¤×•×œ (×¡×¤×¨×™×” + ××¤×œ×™×§×¦×™×”)
10 ×“×§×•×ª:  ×§×¨× ××ª ×”××¨×›×™×˜×§×˜×•×¨×”
15 ×“×§×•×ª:  ×‘× ×” ×‘×•×˜ ××ª×§×“×
30 ×“×§×•×ª:  ×”×•×¡×£ ×¤×™×¦'×¨×™× custom ××• ×”×©×ª××© ×‘×¡×¤×¨×™×” ×‘×¤×¨×•×™×§×˜ ××—×¨
```

### ××‘× ×” ×”×¤×¨×•×™×§×˜×™×

#### ×”×¡×¤×¨×™×” - whatsapi-python/
```
whatsapi-python/
â”œâ”€â”€ setup.py
â”œâ”€â”€ README.md
â””â”€â”€ whatsapi/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ providers/
    â”‚   â”œâ”€â”€ base.py          # WhatsAppProvider (interface)
    â”‚   â””â”€â”€ evolution.py     # EvolutionAPIProvider
    â”œâ”€â”€ models/
    â”‚   â”œâ”€â”€ message.py       # WhatsAppMessage
    â”‚   â””â”€â”€ contact.py
    â””â”€â”€ webhook/
        â””â”€â”€ handler.py       # WebhookHandler
```

#### ×”××¤×œ×™×§×¦×™×” - WhatsSynergy/
```
WhatsSynergy/
â”œâ”€â”€ main.py              # × ×§×•×“×ª ×›× ×™×¡×”
â”œâ”€â”€ requirements.txt     # ×›×•×œ×œ: whatsapi-python
â”œâ”€â”€ .env                 # ×”×’×“×¨×•×ª
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ bot.py          # Bot class
â”‚   â”œâ”€â”€ handlers/       # Handler registry
â”‚   â”œâ”€â”€ filters/        # Filter system
â”‚   â””â”€â”€ database/       # Database models
â”œâ”€â”€ plugins/            # ×”×§×•×“ ×”×¢×¡×§×™ ×©×œ×š
â”‚   â”œâ”€â”€ welcome/
â”‚   â”‚   â””â”€â”€ handlers.py
â”‚   â””â”€â”€ admin/
â”‚       â””â”€â”€ commands.py
â””â”€â”€ database/
    â””â”€â”€ bot.db
```

---

## ğŸ—ï¸ ×¡×§×™×¨×” ×›×œ×œ×™×ª

### ××¨×›×™×˜×§×˜×•×¨×” ×“×•-×©×›×‘×ª×™×ª

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              WhatsSynergy (××¤×œ×™×§×¦×™×”)                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  7. Infrastructure   (logging, config, errors)            â•‘
â•‘  6. Data Layer       (database, repositories)             â•‘
â•‘  5. Business Logic   (plugins - ×”×§×•×“ ×”×¢×¡×§×™ ×©×œ×š)          â•‘
â•‘  4. Routing          (Bot class, filters, handlers)       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           â”‚
                           â”‚ ××©×ª××© ×‘...
                           â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘            whatsapi-python (×¡×¤×¨×™×”)                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  3. Message Processing (webhook â†’ WhatsAppMessage)        â•‘
â•‘  2. Application        (FastAPI, HTTP, Webhook Handler)   â•‘
â•‘  1. Communication      (EvolutionAPIProvider)             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        â”‚                                             â–²
        â”‚ send_message()                       webhook â”‚
        â–¼                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Evolution API â†’ WhatsApp                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ×”×¡×¤×¨×™×™×” vs ×”××¤×œ×™×§×¦×™×”

#### ğŸ“¦ `whatsapi-python` - ×”×¡×¤×¨×™×”
**×ª×¤×§×™×“:** ×¤×¨×•×˜×•×§×•×œ ×ª×§×©×•×¨×ª ×¢× WhatsApp  
**×”×ª×§× ×”:** `pip install whatsapi-python`  
**××›×™×œ:**
- EvolutionAPIProvider (adapter)
- WhatsAppMessage (models)
- WebhookHandler (parsing)
- ×©×œ×™×—×”/×§×‘×œ×” ×©×œ ×”×•×“×¢×•×ª

**×©×™××•×©:**
```python
from whatsapi import EvolutionAPIProvider

provider = EvolutionAPIProvider(...)
await provider.send_text_message("+972...", "×©×œ×•×")
```

â†’ **× ×™×ª× ×ª ×œ×©×™××•×© ×‘×›×œ ×¤×¨×•×™×§×˜ Python**

#### ğŸ¤– WhatsSynergy - ×”××¤×œ×™×§×¦×™×”
**×ª×¤×§×™×“:** ×‘×•×˜ ××œ× ×¢× plugins ×•-business logic  
**×”×ª×§× ×”:** `git clone` + `pip install -r requirements.txt`  
**××›×™×œ:**
- Bot framework
- Plugin system
- Filter system
- Database layer
- ×”×§×•×“ ×”×¢×¡×§×™ ×©×œ×š

**×©×™××•×©:**
```python
from whatsapi import EvolutionAPIProvider
from app.bot import Bot

provider = EvolutionAPIProvider(...)
bot = Bot(provider)
bot.load_plugins("plugins")
bot.run()
```

â†’ **××¤×œ×™×§×¦×™×” ×¡×¤×¦×™×¤×™×ª ×©××©×ª××©×ª ×‘×¡×¤×¨×™×”**

### ×œ××” ×”×¤×¨×“×”?

**×™×ª×¨×•× ×•×ª:**
- âœ… **×©×™××•×© ×—×•×–×¨** - ×”×¡×¤×¨×™×” ×©×™××•×©×™×ª ×œ×›×œ ×¤×¨×•×™×§×˜ WhatsApp
- âœ… **×’××™×©×•×ª** - ××¤×©×¨ ×œ×‘× ×•×ª ×‘×•×˜×™× ××—×¨×™× ×¢× ×”×¡×¤×¨×™×”
- âœ… **×¤×™×ª×•×— ×¢×¦×××™** - ×¢×“×›×•×Ÿ ×”×¡×¤×¨×™×” ×œ× ××©×¤×™×¢ ×¢×œ ×”×‘×•×˜
- âœ… **××™× ×˜×’×¨×¦×™×”** - ××¤×©×¨ ×œ×”×©×ª××© ×‘×¡×¤×¨×™×” ×‘××¢×¨×›×•×ª ×§×™×™××•×ª

**×“×•×’×××•×ª ×©×™××•×©:**
```python
# ×“×•×’××” 1: ×‘×•×˜ ×¤×©×•×˜ ×œ×œ× WhatsSynergy
from whatsapi import EvolutionAPIProvider, WebhookHandler
from fastapi import FastAPI

app = FastAPI()
provider = EvolutionAPIProvider(...)

@app.post("/webhook")
async def webhook(data: dict):
    message = WebhookHandler.parse(data)
    if message.text == "×”×™×™":
        await provider.send_text_message(
            message.from_number, "×©×œ×•×!"
        )

# ×“×•×’××” 2: ××™× ×˜×’×¨×¦×™×” ×‘××¢×¨×›×ª CRM
from whatsapi import EvolutionAPIProvider

class CRMNotifier:
    def __init__(self):
        self.whatsapp = EvolutionAPIProvider(...)
    
    async def notify_customer(self, phone, message):
        await self.whatsapp.send_text_message(phone, message)

# ×“×•×’××” 3: WhatsSynergy - ×‘×•×˜ ××œ×
from whatsapi import EvolutionAPIProvider
from app.bot import Bot

bot = Bot(EvolutionAPIProvider(...))
bot.load_plugins("plugins")
bot.run()
```

---

## ğŸ§± ×©×‘×¢ ×©×›×‘×•×ª ×”××¢×¨×›×ª

### 1ï¸âƒ£ Communication Layer (×¡×¤×¨×™×”: `whatsapi-python`)

**×ª×¤×§×™×“:** ×’×©×¨ ×œ-WhatsApp ×“×¨×š Evolution API

**××™×§×•×:** ×—×œ×§ ××¡×¤×¨×™×™×ª `whatsapi-python` âœ…

**××—×¨×™×•×ª:**
- ×©×œ×™×—×ª ×”×•×“×¢×•×ª (×˜×§×¡×˜, ××“×™×”, ×§×‘×¦×™×)
- ×§×‘×œ×ª ×¡×˜×˜×•×¡ ×”×•×“×¢×•×ª
- × ×™×”×•×œ instances
- ×”×’×“×¨×ª webhooks

**×¢×™×¦×•×‘ ××¨×›×–×™: Adapter Pattern**
```python
# ×××©×§ ×‘×¡×™×¡×™
class WhatsAppProvider(ABC):
    @abstractmethod
    async def send_text_message(to: str, text: str)
    
    @abstractmethod
    async def send_media_message(to: str, media_url: str)

# ××™××•×© ×¡×¤×¦×™×¤×™
class EvolutionAPIProvider(WhatsAppProvider):
    # ××™××•×© Evolution API
    ...
```

**×œ××” Adapter?**  
×›×“×™ ×©×”×¡×¤×¨×™×” ×ª×•×›×œ ×œ×ª××•×š ×‘×¡×¤×§×™× × ×•×¡×¤×™×:
- EvolutionAPIProvider (×›×¨×’×¢)
- TwilioProvider (×¢×ª×™×“)
- BaileysDirectProvider (×¢×ª×™×“)

â†’ **×”×—×œ×¤×ª ×¡×¤×§ = ×”×—×œ×¤×ª provider ×‘×œ×‘×“**

**×–×¨×™××” ×™×•×¦××ª:**
```
××¤×œ×™×§×¦×™×” â†’ whatsapi.EvolutionAPIProvider.send_text_message() 
          â†’ HTTP POST ×œEvolution API 
          â†’ WhatsApp
```

**×“×•×’××ª ×©×™××•×© ×™×©×™×¨ (×œ×œ× ×‘×•×˜):**
```python
from whatsapi import EvolutionAPIProvider

provider = EvolutionAPIProvider(
    base_url="http://localhost:8080",
    api_key="your-key",
    instance_name="my_instance"
)

# ×©×œ×™×—×” ×™×©×™×¨×”
await provider.send_text_message(
    "+972501234567",
    "×©×œ×•× ××”×¡×¤×¨×™×”!"
)
```

---

### 2ï¸âƒ£ Application Layer (×¡×¤×¨×™×”: `whatsapi-python`)

**×ª×¤×§×™×“:** ×§×‘×œ×ª webhooks ×-Evolution API

**××™×§×•×:** ×—×œ×§ ××¡×¤×¨×™×™×ª `whatsapi-python` âœ…

**××—×¨×™×•×ª:**
- ×§×‘×œ×ª POST /webhook
- Parsing ×©×œ payload
- ×”××¨×” ×œ-WhatsAppMessage

**×¢×™×¦×•×‘: WebhookHandler (×œ×œ× FastAPI!)**

```python
# ×”×¡×¤×¨×™×” ××¡×¤×§×ª handler - ×œ× ×©×¨×ª!
from whatsapi import WebhookHandler

# ×‘××¡×’×¨×ª web ×©×œ ×”××©×ª××© (Flask, FastAPI, Django...)
@app.post("/webhook")
async def webhook(data: dict):
    message = WebhookHandler.parse(data)
    # ×¢×›×©×™×• ××¤×©×¨ ×œ×˜×¤×œ ×‘×”×•×“×¢×”
    ...
```

**×œ××” ×œ× FastAPI ×‘×¡×¤×¨×™×”?**
- âœ… ×”××©×ª××© ×‘×•×—×¨ web framework (Flask/FastAPI/Django)
- âœ… ×”×¡×¤×¨×™×” ×¨×§ ××¡×¤×§×ª parsing
- âœ… ×’××™×©×•×ª ××§×¡×™××œ×™×ª

**×–×¨×™××” × ×›× ×¡×ª:**
```
Evolution API â†’ POST /webhook â†’ [FastAPI ×©×œ ×”××©×ª××©] 
              â†’ WebhookHandler.parse() 
              â†’ WhatsAppMessage
```

**×‘-WhatsSynergy (×”××¤×œ×™×§×¦×™×”):**
```python
# main.py
from fastapi import FastAPI
from whatsapi import WebhookHandler

app = FastAPI()

@app.post("/webhook")
async def handle_webhook(data: dict):
    message = WebhookHandler.parse(data)  # ××”×¡×¤×¨×™×”!
    await bot.process_message(message)     # ×œ×•×’×™×§×ª ×”×‘×•×˜
```

---

### 3ï¸âƒ£ Message Processing Layer (×¡×¤×¨×™×”: `whatsapi-python`)

**×ª×¤×§×™×“:** ×”××¨×ª webhooks ×œ×¤×•×¨××˜ ××—×™×“

**××™×§×•×:** ×—×œ×§ ××¡×¤×¨×™×™×ª `whatsapi-python` âœ…

**×”×‘×¢×™×”:**
Evolution ×©×•×œ×— webhooks ××•×¨×›×‘×™× ×•×ª×œ×•×™×™-Baileys:
```json
{
  "event": "messages.upsert",
  "data": {
    "key": {"remoteJid": "972501234567@s.whatsapp.net"},
    "message": {"conversation": "×”×™×™"}
  }
}
```

**×”×¤×ª×¨×•×Ÿ:**
`WebhookHandler.parse()` ×× ×¨××œ ×œ-**WhatsAppMessage**:
```python
WhatsAppMessage(
    message_id="ABC123",
    from_number="+972501234567",
    text="×”×™×™",
    message_type=MessageType.TEXT,
    timestamp=datetime.now()
)
```

**×ª×”×œ×™×š:**
1. **Validation** - ×‘×“×™×§×ª ×ª×§×™× ×•×ª JSON
2. **Extraction** - ×—×™×œ×•×¥ ××™×“×¢ (phone parsing, text, media)
3. **Type Detection** - ×–×™×”×•×™ ×˜×™×¤×•×¡ (text/image/video...)
4. **Construction** - ×™×¦×™×¨×ª WhatsAppMessage

**×œ××” Dataclass?**
- Type safety
- Autocomplete ×‘-IDE
- Validation ××•×˜×•××˜×™
- Serialization (JSON/dict)

**×©×™××•×© ×‘×¡×¤×¨×™×”:**
```python
from whatsapi import WebhookHandler, WhatsAppMessage

message: WhatsAppMessage = WebhookHandler.parse(webhook_data)
print(message.text)  # autocomplete ×¢×•×‘×“!
```

---

### 4ï¸âƒ£ Routing & Dispatch Layer (××¤×œ×™×§×¦×™×”: WhatsSynergy)

**×ª×¤×§×™×“:** × ×™×ª×•×‘ ×”×•×“×¢×•×ª ×œ-handlers

**××™×§×•×:** ×—×œ×§ ×××¤×œ×™×§×¦×™×™×ª WhatsSynergy ğŸ¤–

**×–×• ×œ×™×‘×ª ×”×‘×•×˜** - ××—×‘×¨×ª ×‘×™×Ÿ ×”×•×“×¢×•×ª (××”×¡×¤×¨×™×”) ×œ×§×•×“ ×©×œ×š

**×¨×›×™×‘×™×:**
- **Bot Class** - ×”××—×œ×§×” ×”××¨×›×–×™×ª
- **Handler Registry** - ×¨×©×™××ª handlers ×¨×©×•××™×
- **Filter System** - ××¢×¨×›×ª ×¤×™×œ×˜×¨×™×
- **Dispatcher** - ×”×¨×¦×ª handler ××ª××™×

**×¢×™×¦×•×‘: Decorator Pattern**
```python
from app.bot import Bot
from app.filters import filters

@Bot.on_message(filters.command("start"))
async def handle(client, message):
    # client = Bot instance
    # client.provider = EvolutionAPIProvider ××”×¡×¤×¨×™×”!
    await client.provider.send_text_message(...)
```

**×œ××” Decorator?**
- ×§×•×“ × ×§×™ ×•×§×¨×™×
- ×“×•××” ×œ-Flask/FastAPI (××•×›×¨ ×œ××¤×ª×—×™×)
- ×¤×©×•×˜ ×œ×œ××•×“
- ×”×¨×—×‘×” ×§×œ×”

**×ª×”×œ×™×š:**
```
WhatsAppMessage (××”×¡×¤×¨×™×”)
    â†“
Bot.process_message()
    â†“
×¢×‘×•×¨ ×¢×œ handlers ×¨×©×•××™×
    â†“
×‘×“×•×§ filter ×©×œ ×›×œ handler
    â†“
×”×¨×¥ handler ×¨××©×•×Ÿ ×©×¢×•×‘×¨
```

**×”×§×©×¨ ×œ×¡×¤×¨×™×”:**
```python
# ×‘×ª×•×š Bot class
class Bot:
    def __init__(self, provider: WhatsAppProvider):  # ××”×¡×¤×¨×™×”!
        self.provider = provider
    
    async def process_message(self, message: WhatsAppMessage):  # ××”×¡×¤×¨×™×”!
        for handler_info in self.handlers:
            filter_result = await handler_info["filter"](message)
            if filter_result.passed:
                await handler_info["handler"](self, message)
                break
```

---

### 5ï¸âƒ£ Business Logic Layer (×”×§×•×“ ×©×œ×š)

**×ª×¤×§×™×“:** ×”×¤×œ××’×™× ×™× - ×”×§×•×“ ×”×¢×¡×§×™ ×©××ª×” ×›×•×ª×‘

**××™×§×•×:** ×‘×ª×™×§×™×™×ª `plugins/` ×‘××¤×œ×™×§×¦×™×” ×©×œ×š ğŸ“

**×–×” ×”×§×•×“ ×©×œ×š!** ×œ× ×—×œ×§ ××”×¡×¤×¨×™×” ×•×œ× ××”×‘×•×˜ - ×–×• ×”×œ×•×’×™×§×” ×”×¢×¡×§×™×ª ×”×¡×¤×¦×™×¤×™×ª ×©×œ×š.

**××‘× ×” ×¤×œ××’×™×Ÿ:**
```
plugins/welcome/
â”œâ”€â”€ __init__.py
â””â”€â”€ handlers.py    â† @Bot.on_message(...) ×›××Ÿ
```

**handlers.py:**
```python
from app.bot import Bot           # ××”×‘×•×˜
from app.filters import filters   # ××”×‘×•×˜
from whatsapi import WhatsAppMessage  # ××”×¡×¤×¨×™×”!

@Bot.on_message(filters.command("start"))
async def welcome(client: Bot, message: WhatsAppMessage):
    # ×”×œ×•×’×™×§×” ×©×œ×š ×›××Ÿ!
    await client.provider.send_text_message(  # provider ××”×¡×¤×¨×™×”!
        message.from_number,
        "×‘×¨×•×š ×”×‘×!"
    )
```

**×˜×¢×™× ×” ×“×™× ××™×ª:**
```python
# ×‘-main.py
bot.load_plugins("plugins")  # ×¡×•×¨×§ ×•××™×™×‘× ××•×˜×•××˜×™×ª!
```

**×‘×™×“×•×“:**
×©×’×™××” ×‘×¤×œ××’×™×Ÿ ××—×“ ×œ× ××©×¤×™×¢×” ×¢×œ ××—×¨×™× (try-catch ×œ×›×œ handler)

**State Management:**
××ª×” ×‘×•×—×¨:
- ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× (×¤×©×•×˜)
- Database (××ª××™×“)
- Redis (××”×™×¨)
- ×›×œ ×¤×ª×¨×•×Ÿ ××—×¨

**×’×™×©×” ×œ×¡×¤×¨×™×”:**
```python
# ×‘×ª×•×š handler
async def my_handler(client: Bot, message: WhatsAppMessage):
    # ×©×œ×™×—×ª ×”×•×“×¢×” (×“×¨×š ×”×¡×¤×¨×™×”)
    await client.provider.send_text_message(...)
    
    # ×©×œ×™×—×ª ×ª××•× ×” (×“×¨×š ×”×¡×¤×¨×™×”)
    await client.provider.send_media_message(...)
    
    # ×©×“×•×ª ×”×”×•×“×¢×” (××”×¡×¤×¨×™×”)
    print(message.text)
    print(message.from_number)
```

---

### 6ï¸âƒ£ Data Layer (××¤×œ×™×§×¦×™×”: WhatsSynergy)

**×ª×¤×§×™×“:** ××—×¡×•×Ÿ × ×ª×•× ×™× - **××•×“×•×œ×¨×™ ×œ×—×œ×•×˜×™×Ÿ!**

**××™×§×•×:** ×—×œ×§ ×××¤×œ×™×§×¦×™×™×ª WhatsSynergy ğŸ¤–

**×¢×™×¦×•×‘ ×—×“×©: Database ××•×“×•×œ×¨×™ ×¢× SQLModel**

#### Core Database - ××™× ×™××œ×™!
```python
# app/database/core.py
from sqlmodel import SQLModel, create_engine

class CoreDB:
    def __init__(self, db_url: str):
        self.engine = create_engine(db_url)
    
    def create_tables(self):
        SQLModel.metadata.create_all(self.engine)  # ×›×œ ×”×˜×‘×œ××•×ª!
```

**×‘×”×ª×—×œ×”:** Core ×¨×™×§! ××™×Ÿ ×˜×‘×œ××•×ª ××•×’×“×¨×•×ª ××¨××©.

#### Plugin Database - ×›×œ ×¤×œ××’×™×Ÿ ×× ×”×œ ××ª ×©×œ×•
```python
# plugins/users/models.py
from sqlmodel import SQLModel, Field

class User(SQLModel, table=True):
    phone: str = Field(primary_key=True)
    name: str
    is_blocked: bool = False
```

**×œ××” SQLModel?**
- âœ… Pydantic + SQLAlchemy ×‘×™×—×“
- âœ… Type hints ××œ××™× (IDE ××•×”×‘!)
- âœ… Validation ××•×˜×•××˜×™
- âœ… ×¤×©×•×˜ ×™×•×ª×¨ ×-SQLAlchemy
- âœ… ×ª××™×›×” ×‘-SQLite/PostgreSQL/MySQL

**××•×“×œ×™×:**
×›×œ ×¤×œ××’×™×Ÿ ××—×œ×™×˜ ××” ×”×•× ×¦×¨×™×š:
- **users plugin** â†’ User, UserSettings
- **analytics plugin** â†’ Event, Metric
- **conversations plugin** â†’ ConversationState, Step
- **welcome plugin** â†’ ××™×Ÿ DB! (××•×¤×¦×™×•× ×œ×™)

**×”×¡×¤×¨×™×” `whatsapi-python` ×œ× ××›×™×œ×” Database!**  
×”×™× ×¨×§ ××˜×¤×œ×ª ×‘×”×•×“×¢×•×ª. ×”×‘×•×˜ ×•×”×¤×œ××’×™× ×™× ××—×œ×™×˜×™× ×¢×œ DB.

---

### 7ï¸âƒ£ Infrastructure Layer (××¤×œ×™×§×¦×™×”: WhatsSynergy)

**×ª×¤×§×™×“:** ×©×™×¨×•×ª×™× ×ª×•××›×™×

**××™×§×•×:** ×—×œ×§ ×××¤×œ×™×§×¦×™×™×ª WhatsSynergy ğŸ¤–

**×¨×›×™×‘×™×:**
- **Logging** - structured (JSON/Text)
- **Configuration** - Pydantic Settings (.env)
- **Error Handling** - exception hierarchy
- **Validators** - input validation

**×”×¡×¤×¨×™×” `whatsapi-python` ×’× ××›×™×œ×” infrastructure ××©×œ×”:**
- Logging ×‘×¡×™×¡×™
- Error handling (WhatsAppError, ProviderError)
- Configuration models (ProviderConfig)

---

## ğŸŒŠ ×–×¨×™××ª × ×ª×•× ×™×

### ×”×•×“×¢×” × ×›× ×¡×ª ××œ××”

```
1. User: "/start" ×‘WhatsApp
        â†“
2. Evolution API ××§×‘×œ
        â†“
3. Webhook â†’ FastAPI POST /webhook
        â†“
4. MessageHandler.parse_webhook()
   - Validation
   - Extraction  
   - WhatsAppMessage created
        â†“
5. Bot.process_message(message)
   - ×¢×‘×•×¨ ×¢×œ handlers
   - ×‘×“×•×§ ×›×œ filter
        â†“
6. filters.command("start")(message)
   - Returns FilterResult(passed=True)
        â†“
7. Handler ××ª×‘×¦×¢:
   async def handle_start(client, message):
       await client.adapter.send_text_message(...)
        â†“
8. EvolutionAdapter.send_text_message()
   - HTTP POST ×œEvolution
        â†“
9. Evolution â†’ WhatsApp
        â†“
10. User ××§×‘×œ ×ª×©×•×‘×”
```

**×–××Ÿ: ~100-300ms**

---

## ğŸ”Œ Evolution API & Adapter

### ××”×• Evolution API?

**×¤×ª×¨×•×Ÿ WhatsApp ×§×•×“ ×¤×ª×•×—**, ××‘×•×¡×¡ ×¢×œ Baileys (WhatsApp Web Protocol)

**×™×ª×¨×•× ×•×ª:**
- âœ… ×—×™× ××™ ×•×œ×œ× ×”×’×‘×œ×•×ª
- âœ… Self-hosted (×©×œ×™×˜×” ××œ××”)
- âœ… Multi-device support
- âœ… QR code authentication

### Adapter Pattern

**×××©×§ ××—×™×“:**
```
send_text_message(to, text)
send_media_message(to, media_url, caption)
get_instance_status()
setup_webhook(url)
```

**××™××•×©×™×:**
- **EvolutionAdapter** (×›×¨×’×¢)
- **×¢×ª×™×“×™:** TwilioAdapter, BaileysAdapter

**×™×ª×¨×•×Ÿ:** ×”×—×œ×¤×ª ×¡×¤×§ = ×”×—×œ×¤×ª adapter ×‘×œ×‘×“

### Setup ××”×™×¨

1. ×”×¨×¥ Evolution API (Docker)
2. ×¦×•×¨ instance
3. ×¡×¨×•×§ QR code
4. ×”×’×“×¨ webhook
5. ××•×›×Ÿ!

---

## ğŸ“¨ Message Handler

### ×ª×¤×§×™×“

**×”××¨×ª webhook ××•×¨×›×‘ â†’ WhatsAppMessage ×¤×©×•×˜**

### Evolution webhook (×œ×¤× ×™):
```json
{
  "event": "messages.upsert",
  "data": {
    "key": {"id": "...", "remoteJid": "972501234567@s.whatsapp.net"},
    "message": {"conversation": "Hello"}
  }
}
```

### WhatsAppMessage (××—×¨×™):
```python
WhatsAppMessage(
    message_id="ABC123",
    from_number="+972501234567",
    text="Hello",
    message_type=MessageType.TEXT,
    timestamp=datetime.now(),
    direction=MessageDirection.INCOMING
)
```

### ×ª×”×œ×™×š

**Validation â†’ Extraction â†’ Type Detection â†’ Construction**

### ×˜×™×¤×•×¡×™ ×”×•×“×¢×•×ª × ×ª××›×™×

- ×˜×§×¡×˜, ×ª××•× ×•×ª, ×•×™×“××•, ××•×“×™×•
- ××¡××›×™×, ××™×§×•×, ××™×© ×§×©×¨
- ××“×‘×§×•×ª (stickers)

---

## ğŸ¤– Bot Interface

### ×”××—×œ×§×” ×”××¨×›×–×™×ª

```python
class Bot:
    def __init__(self, adapter)
    def load_plugins(root_path)
    @staticmethod
    def on_message(filter_obj)
    async def process_message(message)
    def run(host, port)
```

### Decorator API

```python
@Bot.on_message(filters.command("start"))
async def handle_start(client: Bot, message):
    await client.adapter.send_text_message(
        message.from_number,
        "×©×œ×•×!"
    )
```

### Handler Signature

```python
async def handler(client: Bot, message: WhatsAppMessage):
    # client = ××•×‘×™×™×§×˜ Bot (×’×™×©×” ×œ-adapter)
    # message = ××•×‘×™×™×§×˜ WhatsAppMessage
```

### Handler Registry

**××™×š ×–×” ×¢×•×‘×“?**

1. ×‘×–××Ÿ import: `@Bot.on_message()` × ×§×¨×
2. Handler × ×©××¨ ×‘-`_UNBOUND_HANDLERS` (×¨×©×™××” ×–×× ×™×ª)
3. `bot.load_plugins()` ××××¥ ××ª ×›×œ ×”×”handlers
4. ×›×œ ×‘×•×˜ ××§×‘×œ ×¢×•×ª×§ ×¢×¦×××™

**×œ××” Static?**
×›×“×™ ×œ××¤×©×¨ ×¨×™×©×•× ×œ×¤× ×™ ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ Bot

---

## ğŸ” ××¢×¨×›×ª ×”×¤×™×œ×˜×¨×™×

### ××”× ×¤×™×œ×˜×¨×™×?

**×ª× ××™× ×©×§×•×‘×¢×™× ×× handler ×¦×¨×™×š ×œ×˜×¤×œ ×‘×”×•×“×¢×”**

### Built-in Filters

```python
# ×˜×™×¤×•×¡ ×”×•×“×¢×”
filters.text        # ×˜×§×¡×˜
filters.image       # ×ª××•× ×•×ª
filters.video       # ×•×™×“××•
filters.audio       # ××•×“×™×•
filters.document    # ××¡××›×™×

# ×˜×™×¤×•×¡ ×¦'××˜
filters.private     # ×¤×¨×˜×™
filters.group       # ×§×‘×•×¦×”

# ×¤×§×•×“×•×ª
filters.command()           # ×›×œ ×¤×§×•×“×” (/)
filters.command("start")    # ×¤×§×•×“×” ×¡×¤×¦×™×¤×™×ª
filters.command(["hi", "hello"])  # ××¡×¤×¨ ×¤×§×•×“×•×ª
```

### ×©×™×œ×•×‘ ×¤×™×œ×˜×¨×™× (Composable)

```python
# AND (×©× ×™×”× ×—×™×™×‘×™×)
filters.text & filters.private

# OR (××—×“ ××¡×¤×™×§)
filters.image | filters.video

# NOT (×œ× ×¦×¨×™×š)
~filters.command()

# ××•×¨×›×‘
(filters.command("admin") & filters.private) | filters.command("sudo")
```

### ×¤×™×œ×˜×¨ ××•×ª××

```python
from whatssynergy import Filter, FilterResult

class VIPFilter(Filter):
    def __init__(self, vip_numbers):
        self.vip_numbers = vip_numbers
    
    async def __call__(self, message):
        if message.from_number in self.vip_numbers:
            return FilterResult(passed=True)
        return FilterResult(passed=False)

# ×©×™××•×©
vip = VIPFilter(["+972501234567"])
@Bot.on_message(vip & filters.command("vip"))
async def vip_handler(client, message):
    ...
```

### ×—×™×œ×•×¥ × ×ª×•× ×™× ××¤×™×œ×˜×¨

```python
@Bot.on_message(filters.command("echo"))
async def echo(client, message):
    # ×—×œ×¥ args
    result = await filters.command("echo")(message)
    args = result.data.get("args", "")
    
    await client.adapter.send_text_message(
        message.from_number,
        f"×”×“×”×•×“: {args}"
    )
```

---

## ğŸ§© ××¢×¨×›×ª ×”×¤×œ××’×™× ×™×

### ××‘× ×” ×¤×œ××’×™×Ÿ

```
plugins/
â””â”€â”€ welcome/
    â”œâ”€â”€ __init__.py       # ×¨×™×§ ××• ×¢× imports
    â”œâ”€â”€ handlers.py       # ×”×§×•×“ ×”×¢×™×§×¨×™
    â””â”€â”€ metadata.json     # ××•×¤×¦×™×•× ×œ×™
```

### handlers.py

```python
from whatssynergy import Bot, filters

@Bot.on_message(filters.command("start"))
async def start(client, message):
    await client.adapter.send_text_message(
        message.from_number,
        "×‘×¨×•×š ×”×‘×!"
    )

@Bot.on_message(filters.command("help"))
async def help_cmd(client, message):
    await client.adapter.send_text_message(
        message.from_number,
        "×¤×§×•×“×•×ª: /start, /help"
    )
```

### metadata.json (××•×¤×¦×™×•× ×œ×™)

```json
{
  "name": "Welcome Plugin",
  "version": "1.0.0",
  "author": "Your Name",
  "description": "×¤×œ××’×™×Ÿ ×‘×¨×›×ª ×§×‘×œ×”",
  "enabled": true
}
```

### ×˜×¢×™× ×” ×“×™× ××™×ª

```python
# ×‘-main.py
bot = Bot(adapter)
bot.load_plugins("plugins")  # ×¡×•×¨×§ ×”×›×œ ××•×˜×•××˜×™×ª!
```

**××” ×§×•×¨×”?**
1. ×¡×¨×™×§×ª ×ª×™×§×™×™×ª plugins/
2. ×™×™×‘×•× ×›×œ ×§×•×‘×¥ .py
3. ××™×¡×•×£ ×›×œ ×”-handlers ×-`_UNBOUND_HANDLERS`
4. ×›×œ ×‘×•×˜ ××§×‘×œ ×¢×•×ª×§ ×¢×¦×××™

**×™×ª×¨×•× ×•×ª:**
- ×”×•×¡×£ ×¤×œ××’×™×Ÿ = ×¦×•×¨ ×ª×™×§×™×™×”
- ×”×¡×¨ ×¤×œ××’×™×Ÿ = ××—×§ ×ª×™×§×™×™×”
- ××™×Ÿ imports ×™×“× ×™×™×

### ×‘×™×“×•×“ ×©×’×™××•×ª

```python
# ×‘×ª×•×š Bot.process_message()
for handler_info in self.handlers:
    try:
        await handler_info["handler"](self, message)
        break  # × ××¦× match - ×¢×¦×•×¨
    except Exception as e:
        logger.error(f"Handler error: {e}")
        continue  # ×”××©×š ×œhandler ×”×‘×
```

**×ª×•×¢×œ×ª:** ×‘××’ ×‘×¤×œ××’×™×Ÿ ××—×“ ×œ× ××¤×™×œ ××ª ×”×‘×•×˜

---

## ğŸ—„ï¸ Database Layer - ××•×“×•×œ×¨×™!

### ×”×¨×¢×™×•×Ÿ: Database ×œ×¤×™ ×¦×•×¨×š

**××™×Ÿ Database ××¨×›×–×™!** ×›×œ ×¤×œ××’×™×Ÿ ×× ×”×œ ××ª ×”×˜×‘×œ××•×ª ×©×œ×•.

#### Core Database
```python
# app/database/core.py
from sqlmodel import SQLModel, create_engine, Session

class CoreDB:
    """Database ×‘×¡×™×¡×™ - ×¨×™×§ ×‘×”×ª×—×œ×”!"""
    def __init__(self, db_url: str = "sqlite:///database/bot.db"):
        self.engine = create_engine(db_url)
    
    def create_tables(self):
        """×™×•×¦×¨ ××ª ×›×œ ×”×˜×‘×œ××•×ª (core + plugins)"""
        SQLModel.metadata.create_all(self.engine)
    
    def get_session(self) -> Session:
        return Session(self.engine)
```

**×‘×”×ª×—×œ×” ×¨×™×§!** × ×•×¡×™×£ ×˜×‘×œ××•×ª core ×¨×§ ×›×©×¦×¨×™×š.

---

### ××‘× ×” ×¤×œ××’×™×Ÿ ×¢× Database

```
plugins/users/
â”œâ”€â”€ __init__.py          # metadata + init_plugin()
â”œâ”€â”€ handlers.py          # ×”handlers
â”œâ”€â”€ models.py            # SQLModel models
â””â”€â”€ repository.py        # DB operations (××•×¤×¦×™×•× ×œ×™)
```

#### __init__.py - Plugin Metadata
```python
"""User Management Plugin"""

PLUGIN_NAME = "users"
PLUGIN_VERSION = "1.0.0"
PLUGIN_DEPENDENCIES = []  # ××™×Ÿ ×ª×œ×•×™×•×ª
PLUGIN_HAS_DATABASE = True

def init_plugin(db):
    """× ×§×¨× ××•×˜×•××˜×™×ª ×‘×–××Ÿ ×˜×¢×™× ×ª ×”×¤×œ××’×™×Ÿ"""
    from .models import User
    print(f"âœ… Plugin '{PLUGIN_NAME}' loaded with database")
```

#### models.py - SQLModel Models
```python
from sqlmodel import SQLModel, Field
from datetime import datetime
from typing import Optional

class User(SQLModel, table=True):
    __tablename__ = "users"
    
    phone: str = Field(primary_key=True)
    name: Optional[str] = None
    is_blocked: bool = False
    created_at: datetime = Field(default_factory=datetime.now)
    updated_at: Optional[datetime] = None
```

**×œ××” SQLModel?**
- âœ… Pydantic + SQLAlchemy ×‘×™×—×“
- âœ… Type hints ××œ××™×
- âœ… Validation ××•×˜×•××˜×™
- âœ… API serialization ××•×‘× ×”
- âœ… ×¤×©×•×˜ ×™×•×ª×¨ ×-SQLAlchemy ×¨×’×™×œ

#### repository.py - DB Operations
```python
from sqlmodel import Session, select
from .models import User

class UserRepository:
    def __init__(self, session: Session):
        self.session = session
    
    def get_or_create(self, phone: str, name: str = None) -> User:
        user = self.session.exec(
            select(User).where(User.phone == phone)
        ).first()
        
        if not user:
            user = User(phone=phone, name=name)
            self.session.add(user)
            self.session.commit()
            self.session.refresh(user)
        
        return user
    
    def is_blocked(self, phone: str) -> bool:
        user = self.session.exec(
            select(User).where(User.phone == phone)
        ).first()
        return user.is_blocked if user else False
```

#### handlers.py - ×©×™××•×© ×‘-DB
```python
from app.bot import Bot
from app.filters import filters
from app.database import get_session
from .repository import UserRepository

@Bot.on_message(filters.command("register"))
async def register(client: Bot, message):
    with get_session() as session:
        repo = UserRepository(session)
        user = repo.get_or_create(
            message.from_number,
            name="New User"
        )
    
    await client.provider.send_text_message(
        message.from_number,
        f"âœ… × ×¨×©××ª ×‘×”×¦×œ×—×”, {user.name}!"
    )
```

---

### ×¤×œ××’×™×Ÿ ×¢× ×ª×œ×•×™×•×ª (Dependencies)

```python
# plugins/analytics/__init__.py
PLUGIN_NAME = "analytics"
PLUGIN_VERSION = "1.0.0"
PLUGIN_DEPENDENCIES = ["users"]  # ×ª×œ×•×™ ×‘-users!
PLUGIN_HAS_DATABASE = True

def init_plugin(db):
    from .models import Event
    print(f"âœ… Plugin '{PLUGIN_NAME}' loaded")
```

```python
# plugins/analytics/models.py
from sqlmodel import SQLModel, Field
from datetime import datetime

class Event(SQLModel, table=True):
    __tablename__ = "analytics_events"
    
    id: int = Field(default=None, primary_key=True)
    user_phone: str = Field(foreign_key="users.phone")  # ×§×©×¨ ×œ-User!
    event_type: str
    data: str  # JSON
    timestamp: datetime = Field(default_factory=datetime.now)
```

```python
# plugins/analytics/handlers.py
from sqlmodel import select
from plugins.users.models import User  # ×™×™×‘×•× ××¤×œ××’×™×Ÿ ××—×¨!
from .models import Event

@Bot.on_message(filters.text)
async def track_message(client: Bot, message):
    with get_session() as session:
        # ×©×™××•×© ×‘××•×“×œ ×©×œ ×¤×œ××’×™×Ÿ ××—×¨
        user = session.exec(
            select(User).where(User.phone == message.from_number)
        ).first()
        
        if user:
            event = Event(
                user_phone=user.phone,
                event_type="message_received",
                data=f'{{"text_length": {len(message.text)}}}'
            )
            session.add(event)
            session.commit()
```

---

### Plugin Loader ××•×˜×•××˜×™

```python
# app/bot.py
import importlib
from pathlib import Path
from typing import List, Dict

class Bot:
    def load_plugins(self, plugins_dir: str):
        """×˜×•×¢×Ÿ ×¤×œ××’×™× ×™× ××•×˜×•××˜×™×ª ×¢× dependency resolution"""
        
        plugins_path = Path(plugins_dir)
        
        # 1. ×’×™×œ×•×™ ×¤×œ××’×™× ×™×
        discovered = self._discover_plugins(plugins_path)
        
        # 2. ××™×•×Ÿ ×œ×¤×™ dependencies (topological sort)
        sorted_plugins = self._sort_by_dependencies(discovered)
        
        # 3. ×˜×¢×™× ×” ×œ×¤×™ ×¡×“×¨
        for plugin_name in sorted_plugins:
            self._load_plugin(plugin_name, plugins_path)
        
        # 4. ×™×¦×™×¨×ª ×›×œ ×”×˜×‘×œ××•×ª
        from app.database import db
        db.create_tables()
        
        print(f"\nâœ… Loaded {len(self.loaded_plugins)} plugins")
    
    def _discover_plugins(self, plugins_path: Path) -> Dict:
        """××•×¦× ××ª ×›×œ ×”×¤×œ××’×™× ×™×"""
        plugins = {}
        
        for item in plugins_path.iterdir():
            if item.is_dir() and (item / "__init__.py").exists():
                plugin_module = importlib.import_module(f"plugins.{item.name}")
                
                plugins[item.name] = {
                    "name": getattr(plugin_module, "PLUGIN_NAME", item.name),
                    "version": getattr(plugin_module, "PLUGIN_VERSION", "1.0.0"),
                    "dependencies": getattr(plugin_module, "PLUGIN_DEPENDENCIES", []),
                    "has_database": getattr(plugin_module, "PLUGIN_HAS_DATABASE", False),
                    "module": plugin_module
                }
        
        return plugins
    
    def _sort_by_dependencies(self, plugins: Dict) -> List[str]:
        """×××™×™×Ÿ ×¤×œ××’×™× ×™× ×œ×¤×™ ×ª×œ×•×™×•×ª (topological sort)"""
        sorted_list = []
        visited = set()
        
        def visit(name):
            if name in visited:
                return
            
            plugin = plugins.get(name)
            if not plugin:
                raise ValueError(f"Plugin '{name}' not found")
            
            # ×˜×¢×Ÿ ×ª×œ×•×™×•×ª ×§×•×“×
            for dep in plugin["dependencies"]:
                visit(dep)
            
            visited.add(name)
            sorted_list.append(name)
        
        for plugin_name in plugins:
            visit(plugin_name)
        
        return sorted_list
    
    def _load_plugin(self, plugin_name: str, plugins_path: Path):
        """×˜×•×¢×Ÿ ×¤×œ××’×™×Ÿ ×‘×•×“×“"""
        plugin_module = importlib.import_module(f"plugins.{plugin_name}")
        
        # ×§×¨×™××” ×œ-init_plugin ×× ×§×™×™×
        if hasattr(plugin_module, "init_plugin"):
            from app.database import db
            plugin_module.init_plugin(db)
        
        # ×™×™×‘×•× handlers
        importlib.import_module(f"plugins.{plugin_name}.handlers")
        
        self.loaded_plugins[plugin_name] = plugin_module
        
        deps = plugin_module.PLUGIN_DEPENDENCIES
        deps_str = f" (depends on: {', '.join(deps)})" if deps else ""
        print(f"  ğŸ“¦ {plugin_module.PLUGIN_NAME} v{plugin_module.PLUGIN_VERSION}{deps_str}")
```

**×¤×œ×˜:**
```
ğŸ“¦ users v1.0.0
âœ… Plugin 'users' loaded with database
ğŸ“¦ analytics v1.0.0 (depends on: users)
âœ… Plugin 'analytics' loaded with database
ğŸ“¦ welcome v1.0.0

âœ… Loaded 3 plugins
```

---

### ×™×ª×¨×•× ×•×ª ×”××•×“×•×œ×¨×™×•×ª

#### âœ… ××¤×¡ ×”×’×“×¨×” ×™×“× ×™×ª
```python
# ×¤×©×•×˜ ×¦×•×¨ ×¤×œ××’×™×Ÿ ×¢× __init__.py
# ×”×›×œ × ×˜×¢×Ÿ ××•×˜×•××˜×™×ª!
bot.load_plugins("plugins")
```

#### âœ… Dependencies ××˜×•×¤×œ×™×
```python
PLUGIN_DEPENDENCIES = ["users", "auth"]
# ×”×‘×•×˜ ×™×˜×¢×Ÿ users ×•-auth ×œ×¤× ×™!
```

#### âœ… Type Safety ×¢× SQLModel
```python
user: User = repo.get_user("+972...")
user.name  # IDE ×™×•×“×¢ ××” ×™×© ×¤×”!
user.created_at  # autocomplete ××•×©×œ×
```

#### âœ… ×©×™×ª×•×£ ××•×“×œ×™× ×‘×™×Ÿ ×¤×œ××’×™× ×™×
```python
# ×‘×¤×œ××’×™×Ÿ ××—×“
from plugins.users.models import User

# ×©×™××•×© ×‘××•×“×œ ×©×œ ×¤×œ××’×™×Ÿ ××—×¨!
user = session.exec(select(User)...).first()
```

#### âœ… ×¤×œ××’×™× ×™× ×œ×œ× DB
```python
# plugins/ping/__init__.py
PLUGIN_HAS_DATABASE = False  # ×œ× ×¦×¨×™×š DB!

# plugins/ping/handlers.py
@Bot.on_message(filters.command("ping"))
async def ping(client, message):
    await client.provider.send_text_message(
        message.from_number, "pong"
    )
# ××™×Ÿ database.py - ××¢×•×œ×”!
```

---

## ğŸš€ ×”×ª×—×œ×” ××”×™×¨×”

### ×©×œ×‘ 0: ×”×‘×Ÿ ××ª ×”××‘× ×”

```
×”×¡×¤×¨×™×” (whatsapi-python):    ×¤×¨×•×˜×•×§×•×œ WhatsApp
         +
×”××¤×œ×™×§×¦×™×” (WhatsSynergy):    ×”×‘×•×˜ ×©×œ×š
```

### 1. ×”×ª×§× ×ª ×”×¡×¤×¨×™×”

```bash
pip install whatsapi-python
```

### 2. ×©×›×¤×•×œ ×”××¤×œ×™×§×¦×™×”

```bash
git clone https://github.com/yourusername/WhatsSynergy.git
cd WhatsSynergy
pip install -r requirements.txt
```

**requirements.txt:**
```
whatsapi-python>=1.0.0
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
sqlmodel>=0.0.14
python-dotenv>=1.0.0
```

### 3. ×”×’×“×¨×•×ª (.env)

```bash
EVOLUTION_API_URL=http://localhost:8080
EVOLUTION_API_KEY=your_key
WHATSAPP_INSTANCE=my_bot
WEBHOOK_URL=https://yourdomain.com/webhook
```

### 4. main.py (× ×§×•×“×ª ×”×›× ×™×¡×”)

```python
from fastapi import FastAPI
from whatsapi import EvolutionAPIProvider, WebhookHandler  # ××”×¡×¤×¨×™×”!
from app.bot import Bot  # ××”××¤×œ×™×§×¦×™×”!
import os

# ××ª×—×•×œ
app = FastAPI()

provider = EvolutionAPIProvider(
    base_url=os.getenv("EVOLUTION_API_URL"),
    api_key=os.getenv("EVOLUTION_API_KEY"),
    instance_name=os.getenv("WHATSAPP_INSTANCE")
)

bot = Bot(provider)
bot.load_plugins("plugins")

# Webhook
@app.post("/webhook")
async def webhook(data: dict):
    message = WebhookHandler.parse(data)  # ×”×¡×¤×¨×™×” ×¢×•×©×” parsing!
    await bot.process_message(message)     # ×”×‘×•×˜ ××˜×¤×œ!
    return {"status": "ok"}

# ×”×¨×¦×”
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

### 5. plugins/welcome/handlers.py (×”×§×•×“ ×©×œ×š)

```python
from app.bot import Bot
from app.filters import filters
from whatsapi import WhatsAppMessage  # ××”×¡×¤×¨×™×”!

@Bot.on_message(filters.command("start"))
async def start(client: Bot, message: WhatsAppMessage):
    await client.provider.send_text_message(  # provider ××”×¡×¤×¨×™×”!
        message.from_number,
        "×©×œ×•×! ×‘×¨×•×š ×”×‘× ğŸ¤–"
    )
```

### 6. ×”×¨×¥

```bash
python main.py
```

**×–×”×•! ×”×‘×•×˜ ×¤×•×¢×œ!** ğŸ‰

---

### ×©×™××•×© ×‘×¡×¤×¨×™×” ×‘×œ×‘×“ (×œ×œ× WhatsSynergy)

×× ××ª×” ×¨×•×¦×” ×¨×§ ×œ×©×œ×•×—/×œ×§×‘×œ ×”×•×“×¢×•×ª:

```python
from whatsapi import EvolutionAPIProvider, WebhookHandler
from fastapi import FastAPI

app = FastAPI()
provider = EvolutionAPIProvider(...)

@app.post("/webhook")
async def webhook(data: dict):
    message = WebhookHandler.parse(data)
    
    if message.text == "ping":
        await provider.send_text_message(
            message.from_number,
            "pong"
        )
    
    return {"ok": True}
```

**××™×Ÿ ×¦×•×¨×š ×‘-Bot, Filters, Plugins - ×¨×§ ×”×¡×¤×¨×™×”!**

---

## ğŸ’¡ ×“×•×’×××•×ª × ×¤×•×¦×•×ª

### ×¤×§×•×“×” ×¢× ××¨×’×•×× ×˜×™×

```python
@Bot.on_message(filters.command("echo"))
async def echo(client, message):
    result = await filters.command("echo")(message)
    args = result.data.get("args", "")
    
    if not args:
        text = "×©×™××•×©: /echo <×˜×§×¡×˜>"
    else:
        text = f"×”×“×”×•×“: {args}"
    
    await client.adapter.send_text_message(
        message.from_number, text
    )
```

### ×˜×™×¤×•×œ ×‘×ª××•× ×•×ª

```python
@Bot.on_message(filters.image)
async def handle_image(client, message):
    await client.adapter.send_text_message(
        message.from_number,
        "×§×™×‘×œ×ª×™ ××ª ×”×ª××•× ×” ×©×œ×š! ğŸ“¸"
    )
```

### ×¤×¨×˜×™ vs ×§×‘×•×¦×”

```python
@Bot.on_message(filters.private & filters.command("secret"))
async def secret(client, message):
    await client.adapter.send_text_message(
        message.from_number,
        "ğŸ¤« ×–×• ×¤×§×•×“×” ×¡×•×“×™×ª!"
    )

@Bot.on_message(filters.group & filters.command("announce"))
async def announce(client, message):
    await client.adapter.send_text_message(
        message.from_number,
        "ğŸ“¢ ×”×•×“×¢×” ×œ×›×•×œ×!"
    )
```

### ×©×™×—×” ×¨×‘-×©×œ×‘×™×ª

```python
conversation_state = {}

@Bot.on_message(filters.command("register"))
async def start_registration(client, message):
    user = message.from_number
    conversation_state[user] = {"step": "waiting_for_name"}
    
    await client.adapter.send_text_message(
        user, "××” ×©××š?"
    )

@Bot.on_message(filters.text & ~filters.command())
async def handle_response(client, message):
    user = message.from_number
    
    if user not in conversation_state:
        return
    
    state = conversation_state[user]
    
    if state["step"] == "waiting_for_name":
        name = message.text
        state["name"] = name
        state["step"] = "waiting_for_age"
        await client.adapter.send_text_message(
            user, f"×©×œ×•× {name}! ××” ×’×™×œ×š?"
        )
    
    elif state["step"] == "waiting_for_age":
        age = message.text
        name = state["name"]
        await client.adapter.send_text_message(
            user, f"× ×¨×©××ª! ×©×: {name}, ×’×™×œ: {age}"
        )
        del conversation_state[user]
```

### ×©×™××•×© ×‘-Database

```python
from whatssynergy.database import Database, UserRepository

db = Database("database/bot.db")
db.create_tables()
user_repo = UserRepository(db)

@Bot.on_message(filters.command("register"))
async def register(client, message):
    result = await filters.command("register")(message)
    name = result.data.get("args", "×× ×•× ×™××™")
    
    user = user_repo.get_or_create(
        message.from_number,
        name=name
    )
    
    await client.adapter.send_text_message(
        message.from_number,
        f"× ×¨×©××ª ×‘×”×¦×œ×—×”, {user.name}!"
    )
```

### ×‘×“×™×§×ª ×”×¨×©××•×ª

```python
ADMINS = ["+972501234567", "+972507654321"]

@Bot.on_message(filters.command("admin"))
async def admin_cmd(client, message):
    if message.from_number not in ADMINS:
        await client.adapter.send_text_message(
            message.from_number,
            "âŒ ××™×Ÿ ×œ×š ×”×¨×©××”"
        )
        return
    
    await client.adapter.send_text_message(
        message.from_number,
        "âœ… ×¤×§×•×“×ª ×× ×”×œ ×‘×•×¦×¢×”"
    )
```

---

## ğŸ§  ×”×—×œ×˜×•×ª ×ª×›× ×•×Ÿ

### ×œ××” ×”×¤×¨×“×” ×‘×™×Ÿ ×¡×¤×¨×™×” ×œ××¤×œ×™×§×¦×™×”?

**×”×‘×¢×™×”:**
```
×× ×”×›×œ ×‘×¡×¤×¨×™×™×” ××—×ª:
- ×œ× ×’××™×© (×¦×¨×™×š plugin system ××¤×™×œ×• ×œ×©×™××•×© ×¤×©×•×˜)
- ×œ× × ×™×ª×Ÿ ×œ×©×™××•×© ×—×•×–×¨ (××—×™×™×‘ ××‘× ×” ×¡×¤×¦×™×¤×™)
- ×¢×“×›×•×Ÿ ×§×˜×Ÿ = ×”×ª×§× ×” ××—×“×© ×©×œ ×”×›×œ
```

**×”×¤×ª×¨×•×Ÿ:**
```
ğŸ“¦ whatsapi-python (×¡×¤×¨×™×”)
   â†“ ××©××©×ª ××ª...
ğŸ¤– WhatsSynergy (××¤×œ×™×§×¦×™×”)
   â†“ ××©××©×ª ××ª...
ğŸ“ ×”×¤×œ××’×™× ×™× ×©×œ×š
```

**×™×ª×¨×•× ×•×ª:**
- âœ… **×©×™××•×© ×—×•×–×¨** - ×”×¡×¤×¨×™×” ×©×™××•×©×™×ª ×œ×›×œ ×¤×¨×•×™×§×˜
- âœ… **×’××™×©×•×ª** - ××¤×©×¨ ×œ×‘× ×•×ª ×‘×•×˜×™× ××—×¨×™×
- âœ… **×¤×™×ª×•×— ×¢×¦×××™** - ×¢×“×›×•×Ÿ ×¡×¤×¨×™×” â‰  ×©×™× ×•×™ ×‘×•×˜
- âœ… **××™× ×˜×’×¨×¦×™×”** - ×©×™××•×© ×‘××¢×¨×›×•×ª ×§×™×™××•×ª

**×“×•×’×××•×ª:**
```python
# ×©×™××•×© 1: ×¨×§ ×”×¡×¤×¨×™×” (××™× ×˜×’×¨×¦×™×” ×¤×©×•×˜×”)
from whatsapi import EvolutionAPIProvider
provider = EvolutionAPIProvider(...)
await provider.send_text_message("+972...", "×”×™×™")

# ×©×™××•×© 2: ×”××¤×œ×™×§×¦×™×” ×”××œ××” (×‘×•×˜ ×¢× plugins)
from whatsapi import EvolutionAPIProvider
from app.bot import Bot

bot = Bot(EvolutionAPIProvider(...))
bot.load_plugins("plugins")
bot.run()

# ×©×™××•×© 3: ×‘×•×˜ custom ××©×œ×š (×œ×œ× WhatsSynergy)
from whatsapi import EvolutionAPIProvider, WebhookHandler

class MyCustomBot:
    def __init__(self):
        self.provider = EvolutionAPIProvider(...)
    
    async def handle(self, webhook_data):
        msg = WebhookHandler.parse(webhook_data)
        # ×”×œ×•×’×™×§×” ×©×œ×š
```

---

### ×œ××” Class-Based Bot?

**×”×‘×¢×™×” ×¢× Singleton:**
```
×‘×•×˜ ×’×œ×•×‘×œ×™ ××—×“ = ×§×©×” ×œ××¡×¤×¨ ×‘×•×˜×™×, ×§×©×” ×œtesting
```

**×”×¤×ª×¨×•×Ÿ:**
```python
provider1 = EvolutionAPIProvider(...)
provider2 = EvolutionAPIProvider(...)

bot1 = Bot(provider1)  # ×‘×•×˜ 1
bot2 = Bot(provider2)  # ×‘×•×˜ 2 - ×¢×¦×××™ ×œ×’××¨×™
```

**×™×ª×¨×•× ×•×ª:**
- âœ… ××¡×¤×¨ ×‘×•×˜×™× ×‘××§×‘×™×œ
- âœ… Testing ×§×œ (mock provider)
- âœ… State ××‘×•×“×“
- âœ… ×›×œ ×‘×•×˜ ×¢× plugins ×©×•× ×™×

### ×œ××” Static Decorator?

**×”×‘×¢×™×”:**
```
××™×š ×¨×•×©××™× handlers ×œ×¤× ×™ ×™×¦×™×¨×ª Bot?
```

**×”×¤×ª×¨×•×Ÿ:**
```python
@Bot.on_message(...)  # Static - ×¢×•×‘×“ ×‘×–××Ÿ import
```

**××™×š ×–×” ×¢×•×‘×“:**
1. Handler â†’ `_UNBOUND_HANDLERS` (×¨×©×™××” ×–×× ×™×ª)
2. `bot.load_plugins()` â†’ ××××¥ handlers
3. ×›×œ ×‘×•×˜ ××§×‘×œ ×¢×•×ª×§ ×¢×¦×××™

### ×œ××” Async ×‘×›×œ ××§×•×?

**×”×—×œ×˜×”:** async 100%

**×¡×™×‘×•×ª:**
- âš¡ ×‘×™×¦×•×¢×™× ×’×‘×•×”×™×
- ğŸ”„ ×˜×™×¤×•×œ ×‘××¡×¤×¨ ×”×•×“×¢×•×ª ×‘××§×‘×™×œ
- ğŸ¯ FastAPI async native

**××—×™×¨:**
- ×œ××™×“×” ×©×œ async/await
- debugging ××¡×•×‘×š ×™×•×ª×¨

**×”×—×œ×˜×”:** ×”×™×ª×¨×•× ×•×ª ×©×•×•×™×

### ×œ××” Evolution API?

**×¡×™×‘×•×ª:**
- âœ… ×§×•×“ ×¤×ª×•×—
- âœ… Self-hosted
- âœ… ×—×™× ××™
- âœ… Multi-device

**×¢×ª×™×“:** ×ª××™×›×” ×‘×¡×¤×§×™× × ×•×¡×¤×™× ×“×¨×š Adapter

---

## ğŸ”’ ××‘×˜×—×”

### Input Validation

```python
# ×‘×ª×•×š MessageHandler
def _extract_phone_from_jid(self, jid: str) -> str:
    if not jid or "@" not in jid:
        raise ValueError("Invalid JID")
    
    phone = jid.split("@")[0].replace("+", "")
    
    if not phone.isdigit():
        raise ValueError("Invalid phone number")
    
    return "+" + phone
```

### Rate Limiting

```python
from collections import defaultdict
from datetime import datetime, timedelta

rate_limits = defaultdict(list)
RATE_LIMIT = 10  # messages per minute

def check_rate_limit(user: str) -> bool:
    now = datetime.now()
    rate_limits[user] = [
        ts for ts in rate_limits[user]
        if now - ts < timedelta(minutes=1)
    ]
    
    if len(rate_limits[user]) >= RATE_LIMIT:
        return False
    
    rate_limits[user].append(now)
    return True

@Bot.on_message(filters.command("test"))
async def limited(client, message):
    if not check_rate_limit(message.from_number):
        await client.adapter.send_text_message(
            message.from_number,
            "âŒ ×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª. × ×¡×” ×‘×¢×•×“ ×“×§×”."
        )
        return
    
    await client.adapter.send_text_message(
        message.from_number, "âœ… OK"
    )
```

### Data Privacy

```python
import hashlib

def hash_phone(phone: str) -> str:
    return hashlib.sha256(phone.encode()).hexdigest()[:10]

# ×‘×œ×•×’
logger.info(f"Message from {hash_phone(message.from_number)}")

# âŒ ××œ ×ª×¢×©×”
logger.debug(f"Message: {message.text}")

# âœ… ×‘××§×•×
logger.debug(f"Message type: {message.message_type}")
```

---

## ğŸ“ˆ ×‘×™×¦×•×¢×™× ×•×§× ×” ××™×“×”

### Single Instance

**×™×›×•×œ×ª:**
- ~1000 ××©×ª××©×™× ×¤×¢×™×œ×™×
- ~100-500 ×”×•×“×¢×•×ª/×©× ×™×™×”

**××•×¤×˜×™××™×–×¦×™×•×ª:**

```python
# âŒ ××™×˜×™
await api_call_1()
await api_call_2()
await api_call_3()

# âœ… ××”×™×¨
import asyncio
await asyncio.gather(
    api_call_1(),
    api_call_2(),
    api_call_3()
)
```

### Caching

```python
from functools import lru_cache

@lru_cache(maxsize=1000)
def get_user_data(phone: str):
    return db.query(User).filter_by(phone=phone).first()
```

### Multiple Instances

**××¨×›×™×˜×§×˜×•×¨×”:**
```
Load Balancer
    â”‚
    â”œâ”€â†’ Bot Instance 1
    â”œâ”€â†’ Bot Instance 2
    â””â”€â†’ Bot Instance 3
```

**××ª×’×¨×™×:**
- State sharing (Redis)
- Session affinity
- Database pooling

**××ª×™?** ×™×•×ª×¨ ×-1000 ××©×ª××©×™×

---

## âœ¨ Best Practices

### ××‘× ×” ×§×•×“

```python
# âœ… ×˜×•×‘ - handler ××—×“ ×œ×¤×•× ×§×¦×™×” ××—×ª
@Bot.on_message(filters.command("start"))
async def handle_start(client, message):
    await client.adapter.send_text_message(...)

# âŒ ×¨×¢ - handler ××—×“ ×œ×›×œ
@Bot.on_message(filters.text)
async def handle_everything(client, message):
    if message.text == "/start":
        ...
    elif message.text == "/help":
        ...
```

### Error Handling

```python
# âœ… ×˜×•×‘
@Bot.on_message(filters.command("api"))
async def api_call(client, message):
    try:
        result = await external_api()
        text = f"×ª×•×¦××”: {result}"
    except Exception as e:
        logger.error(f"API error: {e}")
        text = "âŒ ×©×’×™××” ×‘×§×¨×™××” ×œ-API"
    
    await client.adapter.send_text_message(
        message.from_number, text
    )
```

### Logging

```python
import logging

logger = logging.getLogger(__name__)

# âœ… ×¨××•×ª × ×›×•× ×•×ª
logger.debug("×”×ª×—×œ×ª ×¢×™×‘×•×“")      # ×¤×™×ª×•×—
logger.info("×”×•×“×¢×” ×”×ª×§×‘×œ×”")       # ××™×¨×•×¢×™× ×¨×’×™×œ×™×
logger.warning("×¤×œ××’×™×Ÿ ×—×¡×¨")      # ×œ× ×§×¨×™×˜×™
logger.error("×©×’×™××” ×‘handler")    # ×“×•×¨×© ×˜×™×¤×•×œ
logger.critical("DB × ×¤×œ")         # ×”××¢×¨×›×ª ×‘×¡×›× ×”
```

### Testing

```python
# ×™×¦×™×¨×ª MockAdapter ×œ×‘×“×™×§×•×ª
class MockAdapter(WhatsAppAdapter):
    def __init__(self):
        self.sent_messages = []
    
    async def send_text_message(self, to, text):
        self.sent_messages.append({"to": to, "text": text})
        return MessageResponse(success=True)

# ×‘test
adapter = MockAdapter()
bot = Bot(adapter)

# ... ×‘×“×•×§ ××ª adapter.sent_messages
```

---

## âœ… ×¡×™×›×•×

### ××” ×‘× ×™× ×•?

**××¢×¨×›×ª ××•×“×•×œ×¨×™×ª ×œ×‘× ×™×™×ª ×‘×•×˜×™× ×œ-WhatsApp** ×¢×:

**7 ×©×›×‘×•×ª:**
1. Communication (Evolution API)
2. Application (FastAPI)
3. Message Processing (Normalization)
4. Routing (Filters & Handlers)
5. Business Logic (Plugins)
6. Data (Database)
7. Infrastructure (Logging, Config)

**×¢×§×¨×•× ×•×ª:**
- Separation of Concerns
- Loose Coupling
- Easy Extensibility
- Resilience

**×“×¤×•×¡×™ ×ª×›× ×•×Ÿ:**
- Adapter
- Decorator
- Repository
- Strategy
- Chain of Responsibility

### ×œ××¤×ª×— ×—×“×©

**×¡×“×¨ ××•××œ×¥:**
1. ×§×¨× ××ª ×”××¡××š ×”×–×” (××ª×” ×›××Ÿ! âœ…)
2. `pip install whatssynergy`
3. ×¦×•×¨ main.py ×•×¤×œ××’×™×Ÿ ×¨××©×•×Ÿ
4. ×”×¨×¥ ×•×”×ª× ×¡×”
5. ×”×•×¡×£ ×¤×œ××’×™× ×™× × ×•×¡×¤×™×
6. ×”×•×¡×£ database ×œ×©×™×—×•×ª ××•×¨×›×‘×•×ª
7. deploy ×œ-production!

### ××©××‘×™× × ×•×¡×¤×™×

- **GitHub:** [WhatsSynergy](https://github.com/yourusername/whatssynergy)
- **×“×•×’×××•×ª:** ×ª×™×§×™×™×ª `examples/`
- **Issues:** ×“×•×•×— ×¢×œ ×‘××’×™× ××• ×‘×§×© ×¢×–×¨×”

---

**×¡×•×£ ×”××¡××š ×”×××•×—×“** ğŸ“š

*××¡××š ×–×” ××›×™×œ ××ª ×›×œ ×”××™×“×¢ ×”×—×©×•×‘ - ×ª×›× ×•×Ÿ, ××¨×›×™×˜×§×˜×•×¨×”, ×•×“×•×’×××•×ª ××¢×©×™×•×ª.*

**× ×‘× ×” ×‘×™×©×¨××œ ğŸ‡®ğŸ‡± ×¢× â¤ï¸**
